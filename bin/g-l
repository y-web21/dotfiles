#!/usr/bin/env bash

describe() {
  cat <<-EOS
		show log and pick hash
		Args:
		  arg1 = sub command (default log)
		Keybinds:
		  esc: exit
		  ctrl-c: exit
		  enter: echo selected hash
	EOS
}

_pick_hash() {
  local fzf_ret hash input sub_cmd

  sub_cmd="${1:-log}"

  # filetr DBD
  # author alt+a

  while true; do

    unset path
    unset fzf_ret
    while read -r ret; do
      fzf_ret+=("$ret")
    done < <(
      git "${sub_cmd}" --all --oneline |
        fzf-tmux \
          -p 90% \
          --expect=ctrl-c \
          --expect=esc \
          --preview-window=65%,,~6 \
          --preview 'git show --color=always {1}' |
        awk '{print $1}'
    )

    # var check
    # i=0 && for f in "${fzf_ret[@]}"; do echo $i "$f" ;((i++)); done

    input="${fzf_ret[0]}"
    [ "$input" = 'ctrl-c' ] && break
    [ "$input" = 'esc' ] && break

    hash="${fzf_ret[1]}"
    break
  done
  echo "$hash"
}

if [[ "$1" = '--help' || "$1" = '-h' ]]; then
  describe
else
  _pick_hash "$@"
fi
